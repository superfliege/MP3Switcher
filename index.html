<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AB Switcher">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%23667eea'/%3E%3Ctext x='50%25' y='45%25' dominant-baseline='middle' text-anchor='middle' font-size='75' fill='white' font-family='Arial, sans-serif' font-weight='bold'%3EA%3C/text%3E%3Ctext x='50%25' y='70%25' dominant-baseline='middle' text-anchor='middle' font-size='75' fill='white' font-family='Arial, sans-serif' font-weight='bold'%3EB%3C/text%3E%3C/svg%3E">
    <title>Audio A/B Switcher</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .upload-box {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-box:hover {
            background: #f0f0f0;
            border-color: #764ba2;
        }

        .upload-box label {
            display: block;
            cursor: pointer;
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .upload-box input[type="file"] {
            display: none;
        }

        .file-name {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
            word-break: break-all;
        }

        .controls {
            margin: 20px 0 15px 0;
        }

        .ab-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .ab-button {
            font-size: 4.5em;
            font-weight: bold;
            padding: 30px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .ab-button.btn-a {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .ab-button.btn-b {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .ab-button.active {
            transform: scale(0.95);
            box-shadow: inset 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .ab-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .ab-button.active:hover {
            transform: scale(0.95);
        }

        .play-controls {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }

        .play-btn {
            padding: 12px 50px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            background: #667eea;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            min-width: 160px;
        }

        .play-btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .timeline-section {
            margin: 15px 0;
        }

        .timeline-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #666;
            font-size: 0.85em;
        }

        .timeline {
            width: 100%;
            height: 10px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            outline: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .timeline::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #667eea;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .timeline::-webkit-slider-thumb:hover {
            background: #764ba2;
            transform: scale(1.2);
        }

        .timeline::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #667eea;
            cursor: pointer;
            border-radius: 50%;
            border: none;
            transition: all 0.3s;
        }

        .timeline::-moz-range-thumb:hover {
            background: #764ba2;
            transform: scale(1.2);
        }

        .status {
            text-align: center;
            margin-top: 12px;
            color: #666;
            font-size: 1em;
        }

        .active-track {
            font-weight: bold;
            color: #667eea;
        }

        .install-section {
            margin-top: 15px;
            text-align: center;
        }

        .install-btn {
            display: none;
            padding: 10px 30px;
            font-size: 0.95em;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .install-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
        }

        .install-btn.show {
            display: inline-block;
        }

        .eq-section {
            margin-top: 20px;
            border-top: 2px solid #eee;
            padding-top: 20px;
        }

        .eq-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .eq-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
        }

        .eq-reset-btn {
            padding: 6px 12px;
            font-size: 0.85em;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            white-space: nowrap;
        }

        .eq-reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        .eq-reset-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        }

        .eq-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }

        .eq-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .eq-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .eq-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }

        .eq-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .eq-slider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        input:checked + .eq-slider:before {
            transform: translateX(26px);
        }

        .visualizer-container {
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
            background: linear-gradient(to right, #1e3c72, #2a5298);
        }

        #visualizer {
            width: 100%;
            height: 60px;
            display: block;
        }

        .eq-canvas-container {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        #eqCanvas {
            width: 100%;
            height: 250px;
            display: block;
            cursor: crosshair;
            touch-action: none;
        }

        .eq-info {
            margin-top: 12px;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 10px;
            font-size: 0.85em;
            color: #666;
        }

        .eq-band {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .eq-band-label {
            font-weight: bold;
        }

        audio {
            display: none;
        }

        /* Mobile Optimierung */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
                border-radius: 15px;
            }

            h1 {
                font-size: 1.6em;
                margin-bottom: 15px;
            }

            .upload-section {
                grid-template-columns: 1fr;
                gap: 12px;
                margin-bottom: 15px;
            }

            .upload-box {
                padding: 20px 12px;
            }

            .upload-box label {
                font-size: 1.4em;
            }

            .ab-buttons {
                gap: 12px;
                margin-bottom: 12px;
            }

            .ab-button {
                font-size: 5.5em;
                padding: 40px 20px;
                border-radius: 20px;
                min-height: 160px;
            }

            .play-btn {
                width: 100%;
                padding: 18px;
                font-size: 1.3em;
            }

            .timeline {
                height: 15px;
            }

            .timeline::-webkit-slider-thumb {
                width: 30px;
                height: 30px;
            }

            .timeline::-moz-range-thumb {
                width: 30px;
                height: 30px;
            }

            .status {
                font-size: 1.2em;
                margin-top: 12px;
            }

            .eq-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .eq-title {
                font-size: 1.2em;
            }

            .eq-controls {
                width: 100%;
                justify-content: space-between;
                gap: 10px;
            }

            .eq-reset-btn {
                padding: 8px 14px;
                font-size: 0.9em;
            }

            .eq-toggle {
                width: 54px;
                height: 30px;
            }

            .eq-slider:before {
                height: 22px;
                width: 22px;
            }

            input:checked + .eq-slider:before {
                transform: translateX(24px);
            }
        }

        /* Landscape Modus f√ºr Mobilger√§te */
        @media (max-width: 900px) and (orientation: landscape) {
            body {
                padding: 5px;
            }

            .container {
                padding: 12px;
                max-width: 100%;
            }

            h1 {
                font-size: 1.3em;
                margin-bottom: 8px;
            }

            .upload-section {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                margin-bottom: 8px;
            }

            .upload-box {
                padding: 8px;
            }

            .upload-box label {
                font-size: 0.95em;
                margin-bottom: 4px;
            }

            .file-name {
                font-size: 0.65em;
            }

            .ab-buttons {
                gap: 8px;
                margin-bottom: 8px;
            }

            .ab-button {
                font-size: 3.5em;
                padding: 18px;
                min-height: 90px;
            }

            .play-btn {
                padding: 10px 20px;
                font-size: 0.95em;
            }

            .timeline-section {
                margin: 8px 0;
            }

            .status {
                font-size: 0.9em;
                margin-top: 8px;
            }

            .eq-section {
                margin-top: 12px;
                padding-top: 12px;
            }

            .eq-title {
                font-size: 1.1em;
            }

            #visualizer {
                height: 50px;
            }

            #eqCanvas {
                height: 200px;
            }
        }

        /* Extra gro√üe Touch-Targets */
        @media (hover: none) and (pointer: coarse) {
            .ab-button {
                touch-action: manipulation;
            }

            .play-btn {
                touch-action: manipulation;
            }

            button {
                -webkit-tap-highlight-color: transparent;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Audio A/B Switcher</h1>
        
        <div class="upload-section">
            <div class="upload-box" onclick="document.getElementById('fileA').click()">
                <label>Version A</label>
                <input type="file" id="fileA" accept="audio/mp3,audio/mpeg,audio/mp4,audio/m4a,audio/x-m4a">
                <div class="file-name" id="fileNameA">Keine Datei ausgew√§hlt</div>
            </div>
            
            <div class="upload-box" onclick="document.getElementById('fileB').click()">
                <label>Version B</label>
                <input type="file" id="fileB" accept="audio/mp3,audio/mpeg,audio/mp4,audio/m4a,audio/x-m4a">
                <div class="file-name" id="fileNameB">Keine Datei ausgew√§hlt</div>
            </div>
        </div>

        <audio id="audioA" preload="auto"></audio>
        <audio id="audioB" preload="auto"></audio>

        <div class="controls">
            <div class="ab-buttons">
                <button class="ab-button btn-a active" id="btnA">A</button>
                <button class="ab-button btn-b" id="btnB">B</button>
            </div>

            <div class="play-controls">
                <button class="play-btn" id="playPauseBtn">‚ñ∂ Play</button>
            </div>

            <div class="timeline-section">
                <div class="timeline-labels">
                    <span id="currentTime">0:00</span>
                    <span id="duration">0:00</span>
                </div>
                <input type="range" class="timeline" id="timeline" min="0" max="100" value="0" step="0.1">
            </div>
        </div>

        <div class="status">
            Aktive Spur: <span class="active-track" id="activeTrack">A</span>
        </div>

        <div class="install-section">
            <button class="install-btn" id="installBtn">üì± App installieren</button>
        </div>

        <div class="eq-section">
            <div class="eq-header">
                <div class="eq-title">üéõÔ∏è Parametrischer Equalizer</div>
                <div class="eq-controls">
                    <button class="eq-reset-btn" id="eqResetBtn">üîÑ Zur√ºcksetzen</button>
                    <label class="eq-toggle">
                        <input type="checkbox" id="eqToggle">
                        <span class="eq-slider"></span>
                    </label>
                </div>
            </div>

            <div class="visualizer-container">
                <canvas id="visualizer"></canvas>
            </div>

            <div class="eq-canvas-container">
                <canvas id="eqCanvas"></canvas>
            </div>

            <div class="eq-info">
                <div class="eq-band">
                    <span class="eq-band-label" style="color: #f5576c;">‚óè Band 1 (Low Shelf):</span>
                    <span id="band1Info">100 Hz, 0 dB</span>
                </div>
                <div class="eq-band">
                    <span class="eq-band-label" style="color: #38ef7d;">‚óè Band 2 (Bell):</span>
                    <span id="band2Info">1000 Hz, 0 dB</span>
                </div>
                <div class="eq-band">
                    <span class="eq-band-label" style="color: #4facfe;">‚óè Band 3 (High Shelf):</span>
                    <span id="band3Info">10000 Hz, 0 dB</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const fileA = document.getElementById('fileA');
        const fileB = document.getElementById('fileB');
        const audioA = document.getElementById('audioA');
        const audioB = document.getElementById('audioB');
        const btnA = document.getElementById('btnA');
        const btnB = document.getElementById('btnB');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const timeline = document.getElementById('timeline');
        const currentTimeLabel = document.getElementById('currentTime');
        const durationLabel = document.getElementById('duration');
        const activeTrackLabel = document.getElementById('activeTrack');
        const fileNameA = document.getElementById('fileNameA');
        const fileNameB = document.getElementById('fileNameB');
        const installBtn = document.getElementById('installBtn');

        let currentTrack = 'A';
        let isPlaying = false;
        let isSeeking = false;
        let deferredPrompt;

        // Web Audio API Setup
        let audioContext;
        let sourceA, sourceB;
        let analyser;
        let eqBandsA = [];
        let eqBandsB = [];
        let gainNodeA, gainNodeB;
        let eqEnabled = false;
        const eqCanvas = document.getElementById('eqCanvas');
        const eqCtx = eqCanvas.getContext('2d');
        const visualizer = document.getElementById('visualizer');
        const visCtx = visualizer.getContext('2d');
        const eqToggle = document.getElementById('eqToggle');
        const eqResetBtn = document.getElementById('eqResetBtn');

        // EQ Band Initial Settings (Freq in Hz, Gain in dB)
        const defaultBands = [
            { freq: 100, gain: 0, color: '#f5576c' },
            { freq: 1000, gain: 0, color: '#38ef7d' },
            { freq: 10000, gain: 0, color: '#4facfe' }
        ];
        let bands = [
            { freq: 100, gain: 0, color: '#f5576c', x: 0, y: 0 },
            { freq: 1000, gain: 0, color: '#38ef7d', x: 0, y: 0 },
            { freq: 10000, gain: 0, color: '#4facfe', x: 0, y: 0 }
        ];
        let draggingBand = null;

        // Canvas Setup
        function resizeCanvas() {
            eqCanvas.width = eqCanvas.offsetWidth;
            eqCanvas.height = eqCanvas.offsetHeight;
            visualizer.width = visualizer.offsetWidth;
            visualizer.height = visualizer.offsetHeight;
            drawEQ();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Initialize Web Audio
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                analyser.smoothingTimeConstant = 0.8;

                // Create separate EQ chains for A and B for better performance
                sourceA = audioContext.createMediaElementSource(audioA);
                gainNodeA = audioContext.createGain();
                gainNodeA.gain.value = 1;

                // EQ Chain A
                let chainA = sourceA;
                for (let i = 0; i < 3; i++) {
                    const filter = audioContext.createBiquadFilter();
                    // Band 1: Low Shelf, Band 2: Bell (Peaking), Band 3: High Shelf
                    if (i === 0) {
                        filter.type = 'lowshelf';
                    } else if (i === 1) {
                        filter.type = 'peaking';
                        filter.Q.value = 1.0;
                    } else {
                        filter.type = 'highshelf';
                    }
                    filter.frequency.value = bands[i].freq;
                    filter.gain.value = bands[i].gain;
                    eqBandsA.push(filter);
                    chainA.connect(filter);
                    chainA = filter;
                }
                chainA.connect(gainNodeA);

                // Connect Audio B
                sourceB = audioContext.createMediaElementSource(audioB);
                gainNodeB = audioContext.createGain();
                gainNodeB.gain.value = 0;

                // EQ Chain B - separate filters for better performance
                let chainB = sourceB;
                for (let i = 0; i < 3; i++) {
                    const filter = audioContext.createBiquadFilter();
                    // Band 1: Low Shelf, Band 2: Bell (Peaking), Band 3: High Shelf
                    if (i === 0) {
                        filter.type = 'lowshelf';
                    } else if (i === 1) {
                        filter.type = 'peaking';
                        filter.Q.value = 1.0;
                    } else {
                        filter.type = 'highshelf';
                    }
                    filter.frequency.value = bands[i].freq;
                    filter.gain.value = bands[i].gain;
                    eqBandsB.push(filter);
                    chainB.connect(filter);
                    chainB = filter;
                }
                chainB.connect(gainNodeB);

                // Both chains to analyser and destination (stereo output)
                gainNodeA.connect(analyser);
                gainNodeB.connect(analyser);
                analyser.connect(audioContext.destination);

                // Disable muting on audio elements
                audioA.muted = false;
                audioB.muted = false;

                startVisualization();
            }
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(() => console.log('Service Worker registriert'))
                .catch((err) => console.log('Service Worker Fehler:', err));
        }

        // PWA Install Handler
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.classList.add('show');
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    installBtn.classList.remove('show');
                }
                deferredPrompt = null;
            }
        });

        window.addEventListener('appinstalled', () => {
            installBtn.classList.remove('show');
            console.log('App erfolgreich installiert!');
        });

        // Visualization Loop
        function startVisualization() {
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            function draw() {
                requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);

                visCtx.fillStyle = 'rgb(30, 60, 114)';
                visCtx.fillRect(0, 0, visualizer.width, visualizer.height);

                const barWidth = (visualizer.width / bufferLength) * 2.5;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    const barHeight = (dataArray[i] / 255) * visualizer.height;
                    const gradient = visCtx.createLinearGradient(0, visualizer.height - barHeight, 0, visualizer.height);
                    gradient.addColorStop(0, '#4facfe');
                    gradient.addColorStop(1, '#00f2fe');
                    visCtx.fillStyle = gradient;
                    visCtx.fillRect(x, visualizer.height - barHeight, barWidth, barHeight);
                    x += barWidth + 1;
                }
            }
            draw();
        }

        // Draw EQ Canvas
        function drawEQ() {
            const width = eqCanvas.width;
            const height = eqCanvas.height;
            const minFreq = Math.log10(20);
            const maxFreq = Math.log10(20000);
            
            eqCtx.clearRect(0, 0, width, height);

            // Grid
            eqCtx.strokeStyle = '#ddd';
            eqCtx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                eqCtx.beginPath();
                eqCtx.moveTo(0, (height / 10) * i);
                eqCtx.lineTo(width, (height / 10) * i);
                eqCtx.stroke();

                eqCtx.beginPath();
                eqCtx.moveTo((width / 10) * i, 0);
                eqCtx.lineTo((width / 10) * i, height);
                eqCtx.stroke();
            }

            // Center line (0 dB)
            eqCtx.strokeStyle = '#999';
            eqCtx.lineWidth = 2;
            eqCtx.beginPath();
            eqCtx.moveTo(0, height / 2);
            eqCtx.lineTo(width, height / 2);
            eqCtx.stroke();

            // Draw Bands
            bands.forEach((band, index) => {
                // Convert frequency to X position (logarithmic scale 20Hz - 20kHz)
                band.x = ((Math.log10(band.freq) - minFreq) / (maxFreq - minFreq)) * width;

                // Convert gain to Y position (-12dB to +12dB)
                band.y = height / 2 - (band.gain / 12) * (height / 2);

                // Draw point
                eqCtx.fillStyle = band.color;
                eqCtx.beginPath();
                eqCtx.arc(band.x, band.y, 12, 0, Math.PI * 2);
                eqCtx.fill();

                // Draw label
                eqCtx.fillStyle = '#333';
                eqCtx.font = 'bold 12px Arial';
                eqCtx.fillText(`${index + 1}`, band.x - 4, band.y + 4);
            });

            // Draw frequency curve approximation
            if (eqEnabled) {
                eqCtx.strokeStyle = 'rgba(102, 126, 234, 0.5)';
                eqCtx.lineWidth = 3;
                eqCtx.beginPath();
                for (let x = 0; x < width; x++) {
                    const freq = Math.pow(10, (x / width) * (maxFreq - minFreq) + minFreq);
                    let totalGain = 0;
                    bands.forEach(band => {
                        const q = 1.0;
                        const bw = band.freq / q;
                        const response = band.gain / (1 + Math.pow((freq - band.freq) / bw, 2));
                        totalGain += response;
                    });
                    const y = height / 2 - (totalGain / 12) * (height / 2);
                    if (x === 0) eqCtx.moveTo(x, y);
                    else eqCtx.lineTo(x, y);
                }
                eqCtx.stroke();
            }
        }

        // Update EQ Info Display
        function updateEQInfo() {
            document.getElementById('band1Info').textContent = `${Math.round(bands[0].freq)} Hz, ${bands[0].gain.toFixed(1)} dB`;
            document.getElementById('band2Info').textContent = `${Math.round(bands[1].freq)} Hz, ${bands[1].gain.toFixed(1)} dB`;
            document.getElementById('band3Info').textContent = `${Math.round(bands[2].freq)} Hz, ${bands[2].gain.toFixed(1)} dB`;
        }

        // EQ Toggle
        eqToggle.addEventListener('change', (e) => {
            eqEnabled = e.target.checked;
            const gainValue = eqEnabled ? 1 : 0;
            eqBandsA.forEach((band, i) => {
                band.gain.value = eqEnabled ? bands[i].gain : 0;
            });
            eqBandsB.forEach((band, i) => {
                band.gain.value = eqEnabled ? bands[i].gain : 0;
            });
            drawEQ();
        });

        // EQ Reset Button
        eqResetBtn.addEventListener('click', () => {
            // Reset all bands to default values
            bands.forEach((band, i) => {
                band.freq = defaultBands[i].freq;
                band.gain = defaultBands[i].gain;
            });

            // Update Web Audio filters if they exist
            if (audioContext && eqBandsA.length > 0 && eqBandsB.length > 0) {
                bands.forEach((band, i) => {
                    eqBandsA[i].frequency.value = band.freq;
                    eqBandsB[i].frequency.value = band.freq;
                    if (eqEnabled) {
                        eqBandsA[i].gain.value = band.gain;
                        eqBandsB[i].gain.value = band.gain;
                    }
                });
            }

            // Update display
            drawEQ();
            updateEQInfo();
        });

        // Mouse/Touch Events for EQ Canvas
        function getCanvasPosition(e) {
            const rect = eqCanvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function findBandAtPosition(x, y) {
            return bands.findIndex(band => {
                const dx = x - band.x;
                const dy = y - band.y;
                return Math.sqrt(dx * dx + dy * dy) < 20;
            });
        }

        eqCanvas.addEventListener('mousedown', (e) => {
            const pos = getCanvasPosition(e);
            draggingBand = findBandAtPosition(pos.x, pos.y);
        });

        eqCanvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const pos = getCanvasPosition(e);
            draggingBand = findBandAtPosition(pos.x, pos.y);
        });

        function handleMove(e) {
            if (draggingBand !== null && draggingBand >= 0) {
                const pos = getCanvasPosition(e);
                const width = eqCanvas.width;
                const height = eqCanvas.height;

                // Update frequency (X axis, logarithmic)
                const minFreq = Math.log10(20);
                const maxFreq = Math.log10(20000);
                const freqRatio = Math.max(0, Math.min(1, pos.x / width));
                bands[draggingBand].freq = Math.pow(10, freqRatio * (maxFreq - minFreq) + minFreq);

                // Update gain (Y axis, -12 to +12 dB)
                const gainRatio = Math.max(0, Math.min(1, pos.y / height));
                bands[draggingBand].gain = 12 - (gainRatio * 24);

                // Apply to both Web Audio chains
                if (audioContext && eqBandsA[draggingBand] && eqBandsB[draggingBand]) {
                    eqBandsA[draggingBand].frequency.value = bands[draggingBand].freq;
                    eqBandsB[draggingBand].frequency.value = bands[draggingBand].freq;
                    if (eqEnabled) {
                        eqBandsA[draggingBand].gain.value = bands[draggingBand].gain;
                        eqBandsB[draggingBand].gain.value = bands[draggingBand].gain;
                    }
                }

                drawEQ();
                updateEQInfo();
            }
        }

        eqCanvas.addEventListener('mousemove', handleMove);
        eqCanvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            handleMove(e);
        });

        function handleEnd() {
            draggingBand = null;
        }

        eqCanvas.addEventListener('mouseup', handleEnd);
        eqCanvas.addEventListener('mouseleave', handleEnd);
        eqCanvas.addEventListener('touchend', handleEnd);

        // File Upload Handler
        fileA.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                audioA.src = URL.createObjectURL(file);
                fileNameA.textContent = file.name;
                setupAudioSync();
            }
        });

        fileB.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                audioB.src = URL.createObjectURL(file);
                fileNameB.textContent = file.name;
                setupAudioSync();
            }
        });

        // Setup Audio Synchronization
        function setupAudioSync() {
            // Don't use muting anymore, use gain nodes instead
            // Sync playback
            audioA.addEventListener('loadedmetadata', updateDuration);
            audioB.addEventListener('loadedmetadata', updateDuration);
        }

        // A/B Switch Buttons - Use gain nodes for smooth switching
        btnA.addEventListener('click', () => {
            if (currentTrack !== 'A') {
                currentTrack = 'A';
                if (gainNodeA && gainNodeB) {
                    // Smooth crossfade for better performance
                    const now = audioContext.currentTime;
                    gainNodeA.gain.setTargetAtTime(1, now, 0.015);
                    gainNodeB.gain.setTargetAtTime(0, now, 0.015);
                }
                btnA.classList.add('active');
                btnB.classList.remove('active');
                activeTrackLabel.textContent = 'A';
            }
        });

        btnB.addEventListener('click', () => {
            if (currentTrack !== 'B') {
                currentTrack = 'B';
                if (gainNodeA && gainNodeB) {
                    // Smooth crossfade for better performance
                    const now = audioContext.currentTime;
                    gainNodeA.gain.setTargetAtTime(0, now, 0.015);
                    gainNodeB.gain.setTargetAtTime(1, now, 0.015);
                }
                btnA.classList.remove('active');
                btnB.classList.add('active');
                activeTrackLabel.textContent = 'B';
            }
        });

        // Play/Pause Toggle Button
        playPauseBtn.addEventListener('click', () => {
            if (!isPlaying) {
                // Play
                if (audioA.src && audioB.src) {
                    initAudio();
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                    audioA.play();
                    audioB.play();
                    isPlaying = true;
                    playPauseBtn.textContent = '‚è∏ Pause';
                } else {
                    alert('Bitte beide Audio-Dateien hochladen!');
                }
            } else {
                // Pause
                audioA.pause();
                audioB.pause();
                isPlaying = false;
                playPauseBtn.textContent = '‚ñ∂ Play';
            }
        });

        // Timeline Update - optimized sync threshold
        audioA.addEventListener('timeupdate', () => {
            if (!isSeeking && audioA.duration) {
                timeline.value = (audioA.currentTime / audioA.duration) * 100;
                updateCurrentTime();
                
                // Sync B with A - increased threshold for better mobile performance
                if (Math.abs(audioB.currentTime - audioA.currentTime) > 0.3) {
                    audioB.currentTime = audioA.currentTime;
                }
            }
        });

        // Timeline Seeking
        timeline.addEventListener('input', () => {
            isSeeking = true;
        });

        timeline.addEventListener('change', () => {
            const time = (timeline.value / 100) * audioA.duration;
            audioA.currentTime = time;
            audioB.currentTime = time;
            isSeeking = false;
        });

        // Update Time Labels
        function updateCurrentTime() {
            if (audioA.currentTime) {
                currentTimeLabel.textContent = formatTime(audioA.currentTime);
            }
        }

        function updateDuration() {
            if (audioA.duration) {
                durationLabel.textContent = formatTime(audioA.duration);
                timeline.max = 100;
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'a' || e.key === 'A') {
                btnA.click();
            } else if (e.key === 'b' || e.key === 'B') {
                btnB.click();
            } else if (e.key === ' ') {
                e.preventDefault();
                playPauseBtn.click();
            }
        });
    </script>
</body>
</html>
